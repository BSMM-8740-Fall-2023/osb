---
title: "Time series methods"
subtitle: "BSMM8740-2-R-2023F [WEEK - 7]"
author: "L.L. Odette"
footer:  "[bsmm-8740-fall-2023.github.io/osb](https://bsmm-8740-fall-2023.github.io/osb/)"
logo: "images/logo.png"
title-slide-attributes:
  data-background-image: images/my-DRAFT.png
  data-background-size: contain
  data-background-opacity: "0.40"
format: 
  revealjs: 
    theme: slides.scss
    multiplex: true
    transition: fade
    slide-number: true
    margin: 0.05
editor: visual
menu:
  numbers: true
execute:
  freeze: auto
---

```{r opts, include = FALSE}
options(width = 95)
library(knitr)
opts_chunk$set(comment="", 
               digits = 3, 
               tidy = FALSE, 
               prompt = TRUE,
               fig.align = 'center')
require(magrittr)
require(ggplot2)
theme_set(theme_bw(base_size = 18) + theme(legend.position = "top"))
```

## Recap of last week

-   Last week we introduced the Tidymodels framework in R

-   We showed how we can use the Tidymodels framework to create a workflow for data prep, feature engineering, model fitting and model evaluation.

-   Today we look at the using the Tidymodels package to build classification and clustering models.

# Statistical Tools for Causal Inference

## This week

-   Understanding of the basic language to encode causality,
-   Knowledge of the fundamental problems of inference and the biases of intuitive estimators,
-   Understanding of how econometric methods recover treatment effects,
-   Ability to compute these estimators along with an estimate of their precision using the statistical software R.

## The fundamental problems. of inference

When trying to estimate the effect of a program on an outcome, we face two very important and difficult problems: the *Fundamental Problem of Causal Inference* (FPCI) and the *Fundamental Problem of Statistical Inference* (FPSI).

## Rubin Causal Model (RCM)

RCM is made of three distinct building blocks:

-   a treatment allocation rule, that decides which unit receives the treatment;
-   potential outcomes, that measure how each unit reacts to the treatment;
-   the switching equation that relates potential outcomes to observed outcomes through the allocation rule.

## Treatment allocation

Treatment allocation is represented by the variable $D_i$, where $D_i=1$ if unit $i$ receives the treatment and $D_i=0$ if unit $i$ does not receive the treatment.

The treatment allocation rule is critical:

-   it switches the treatment on or off for each unit, it is going to be at the source of the FPCI.
-   the specific properties of the treatment allocation rule are going to matter for the feasibility and bias of the various methods that we are going to study.

## Treatment allocation rules:

Let $Y_i^B$ denote the outcome variable, with $B$ for *before*

Examples:

-   **sharp cutoff**: for threshold level $\bar{Y}$, $D_{i}=\textbf{1}_{Y_{i}^{B}\le\bar{Y}}$
-   **fuzzy cutoff**: for unobserved random variable $V_i$, $D_{i}=\textbf{1}_{Y_{i}^{B}+V_i\le\bar{Y}}$
-   **eligibility and self-selection**: for $E_i$ an eligibility indicator $D_{i}=\textbf{1}_{D_{i}^*{B}*\ge 0}\times E_i$

## Potential outcomes

Each unit can be treated or untreated, and so there are two potential uutcomes:

-   $Y_i^1$: the outcome unit $i$ will have if treated
-   $Y_i^0$: the outcome unit $i$ will have if not treated

## Switching equation

The switching equation. It links the observed outcome to the potential outcomes through the allocation rule:

$$
\begin{align*}
Y_{i} & =\begin{cases}
Y_{i}^{1} & \text{if}\,D_{i}=1\\
Y_{i}^{1} & \text{if}\,D_{i}=1
\end{cases}\\
 & =Y_{i}^{1}D_{i}+Y_{i}^{0}\left(1-D_{i}\right)
\end{align*}
$$

## Switching equation

What the switching equation means is that, for each unit $i$ we get to observe only one of the two potential outcomes. we can [never]{.underline} see both potential outcomes for the same unit at the same time.

For each of the units, one of the two potential outcomes is unobserved - it is **counterfactual**. It can be conceived by an effort of reason: it is the consequence of what would have happened had some action not been taken.

## Treatment effects

Now we can defined the causal effect:

The unit level treatment effect is defined as $\Delta_i^Y=Y_i^1-Y_i^0$ (which cannot be observed).

Note that the treatment effects can be heterogeneous.

## Treatment effects

Average treatment effect on the treated (TT) gives us summary stats on the sample or the population.

$$
\Delta_{TT_{s}}^{Y}=\frac{1}{\sum_{i=1}^{N}D_{i}}\sum_{i=1}^{N}\left(Y_{i}^{1}-Y_{i}^{0}\right)D_{i}
$$ with the corresponding expected value in the population

$$
\Delta_{TT}^{Y}=\mathbb{E}\left[\left.Y_{i}^{1}-Y_{i}^{0}\right|D_{i}=1\right]
$$

## Fundamental problem of causal inference

It is **impossible** to observe TT, either in the *population* or in the *sample*.

$$
\begin{align*}
\Delta_{TT_{s}}^{Y} & =\frac{1}{\sum_{i=1}^{N}D_{i}}\sum_{i=1}^{N}\left(Y_{i}^{1}-Y_{i}^{0}\right)D_{i}\\
 & =\frac{1}{\sum_{i=1}^{N}D_{i}}\sum_{i=1}^{N}Y_{i}D_{i}-\frac{1}{\sum_{i=1}^{N}D_{i}}\sum_{i=1}^{N}Y_{i}^{0}D_{i}
\end{align*}
$$ but $Y_{i}^{0}D_{i}$ is unobserved when $D_i=1$.

## Intuitive casual estimators

We'll look at two intuitive comparisons are often made in order to estimate causal effects: the with/without comparison (WW) and the before/after comparison (BA).

WW compares the average outcomes of the treated units with those of the untreated units BA compares the average outcomes of the treated after taking the treatment to the average outcomes before the treatment.

## Intuitive casual estimators

We'll look at two intuitive comparisons are often made in order to estimate causal effects: the **with/without** comparison (**WW**) and the **before/after** comparison (**BA**).

**WW** compares the average outcomes of the treated units with those of the untreated units. **BA** compares the average outcomes of the treated *after the treatment* to the average outcomes *before the treatment*.

These comparisons try to proxy for the expected counterfactual outcome in the treated group by using an observed quantity.

## Intuitive casual estimators

Unfortunately, both of these proxies are generally poor and provide biased estimates of TT.

The reason that these proxies are poor is that the treatment is not the only factor that differentiates the treated group from the groups used to form the proxy. The intuitive comparisons are biased because factors other than the treatment are correlated to its allocation.

## With/Without comparison

$$
\Delta_{WW}^{Y}=\mathbb{E}\left[\left.Y_{i}\right|D_{i}=1\right] - \mathbb{E}\left[\left.Y_{i}\right|D_{i}=0\right]
$$

Note that this is not the same as the treatment effect on the treated (TT):

$$
\Delta_{TT}^{Y}=\mathbb{E}\left[\left.Y_{i}^{1}-Y_{i}^{0}\right|D_{i}=1\right]
$$

## With/Without comparison

The difference $\Delta_{WW}^{Y}-\Delta_{TT}^{Y}$ is called the selection bias $\Delta_{SB}^{Y}$:

$$
\begin{align*}
\Delta_{SB}^{Y} & =\Delta_{WW}^{Y}-\Delta_{TT}^{Y}\\
 & =\mathbb{E}\left[\left.Y_{i}\right|D_{i}=1\right]-\mathbb{E}\left[\left.Y_{i}\right|D_{i}=0\right]-\mathbb{E}\left[\left.Y_{i}^{1}-Y_{i}^{0}\right|D_{i}=1\right]\\
 & =\mathbb{E}\left[\left.Y_{i}^{0}\right|D_{i}=1\right]-\mathbb{E}\left[\left.Y_{i}^{0}\right|D_{i}=0\right]
\end{align*}
$$

## With/Without comparison

Under what conditions would we have

$$
\mathbb{E}\left[\left.Y_{i}^{0}\right|D_{i}=1\right]-\mathbb{E}\left[\left.Y_{i}^{0}\right|D_{i}=0\right]\ne0
$$

With non-zero selection bias, selection into the treatment biases the effect of the treatment on outcomes.

## With/Without comparison

::: {style="font-size: smaller"}
-   Confounding factors are the factors that generate differences between treated and untreated individuals even in the absence of the treatment.

-   Suppose we wanted to test giving discounts to our smaller-value customers to induce them to buy more. The results of the test could be biased if small-value customer would just buy less anyway.

-   The mere fact of being selected for receiving the discount means that these customers have a host of characteristics that would differentiate them from the unselected customers.
:::

## Identification assumption

There is no selection bias if

$$
\mathbb{E}\left[\left.Y_{i}^{0}\right|D_{i}=1\right]-\mathbb{E}\left[\left.Y_{i}^{0}\right|D_{i}=0\right]=0
$$

i.e. the expected counterfactual outcome of the treated is equal to the expected potential outcome of the untreated in the absence of the treatment.

This is called the **identification assumption**.

## Identification assumption

For the identication assumption to hold, it has to be that **all** the determinants of $D_i$ are actually unrelated to $Y_i^0$.

One way to enforce this assumption is to randomize treatment assignment.

One way to test for the validity of the identification assumption is to compare the values of observed covariates in the treated and untreated group, because differences in covariates an lead to confounding.

## More

-   Read [An Idiot's Guide to Support Vector Machines](https://web.mit.edu/6.034/wwwbob/svm.pdf)

## Recap

-   In this section we have worked with the `tidymodels` package to build a workflow that facilitates building and evaluating multiple models.

-   Combined with the recipes package we now have a complete data modeling framework.
